<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>迷宮獵人</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
            touch-action: none;
        }
        #gameContainer {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        #gameCanvas {
            border: 2px solid #000;
        }
        #gameInfo {
            width: 300px;
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        #joystickContainer {
            position: relative;
            width: 150px;
            height: 150px;
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            margin-top: 20px;
        }
        #joystick {
            position: absolute;
            width: 50px;
            height: 50px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            top: 50px;
            left: 50px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas" width="400" height="400"></canvas>
        <div id="gameInfo">
            <h2>迷宮獵人</h2>
            <p>分數: <span id="score">0</span></p>
            <h3>遊戲規則:</h3>
            <ul>
                <li>使用虛擬搖桿或方向鍵控制藍點移動</li>
                <li>躲避紅點的扇形區域</li>
                <li>收集方塊得分</li>
                <li>被紅點的扇形區域碰到即遊戲結束</li>
            </ul>
            <h3>特殊功能:</h3>
            <ul>
                <li>綠色方塊: 普通得分 (1分)</li>
                <li>黃色方塊: 高分 (3分)</li>
                <li>紫色方塊: 短暫隱身 (2秒)</li>
                <li>藍色方塊: 減緩紅點速度 (3秒)</li>
            </ul>
            <button id="startButton">開始遊戲</button>
        </div>
    </div>
    <div id="joystickContainer">
        <div id="joystick"></div>
    </div>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startButton = document.getElementById('startButton');
        const scoreElement = document.getElementById('score');
        const joystickContainer = document.getElementById('joystickContainer');
        const joystick = document.getElementById('joystick');

        let score = 0;
        let player = { x: 0, y: 0, size: 10 };
        let enemy = { x: 0, y: 0, size: 10, angle: 0, speed: 1 };
        let blocks = [];
        let maze = [];
        let isGameOver = true;
        let isPlayerInvisible = false;
        let isEnemySlowed = false;
        let joystickActive = false;
        let joystickAngle = 0;

        function generateSimpleMaze() {
            maze = [
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,0,1,1,0,0,1,1,0,0,0,0,1,1,0,0,1,1,0,1],
                [1,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,1],
                [1,0,1,0,1,1,0,1,0,0,0,0,1,0,1,1,0,1,0,1],
                [1,0,0,0,1,1,0,0,0,0,0,0,0,0,1,1,0,0,0,1],
                [1,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,1],
                [1,0,1,1,0,0,1,1,0,0,0,0,1,1,0,0,1,1,0,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ];
        }

        function findSafePosition() {
            let x, y;
            do {
                x = Math.floor(Math.random() * 18) + 1;
                y = Math.floor(Math.random() * 8) + 1;
            } while (maze[y][x] === 1);
            return { x: x * 20 + 10, y: y * 20 + 10 };
        }

        function generateBlock() {
            let x, y;
            do {
                x = Math.floor(Math.random() * 19) + 1;
                y = Math.floor(Math.random() * 9) + 1;
            } while (maze[y][x] === 1);
            
            const types = ['green', 'yellow', 'purple', 'blue'];
            const type = types[Math.floor(Math.random() * types.length)];
            blocks.push({ x: x * 20 + 10, y: y * 20 + 10, type });
        }

        function drawMaze() {
            for (let i = 0; i < maze.length; i++) {
                for (let j = 0; j < maze[i].length; j++) {
                    if (maze[i][j] === 1) {
                        ctx.fillStyle = '#000';
                        ctx.fillRect(j * 20, i * 20, 20, 20);
                    }
                }
            }
        }

        function drawPlayer() {
            ctx.fillStyle = isPlayerInvisible ? 'rgba(0, 0, 255, 0.5)' : 'blue';
            ctx.beginPath();
            ctx.arc(player.x, player.y, player.size, 0, Math.PI * 2);
            ctx.fill();
        }

        function drawEnemy() {
            ctx.fillStyle = 'red';
            ctx.beginPath();
            ctx.arc(enemy.x, enemy.y, enemy.size, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = 'rgba(255, 0, 0, 0.3)';
            ctx.beginPath();
            ctx.moveTo(enemy.x, enemy.y);
            ctx.arc(enemy.x, enemy.y, 60, enemy.angle - Math.PI/4, enemy.angle + Math.PI/4);
            ctx.lineTo(enemy.x, enemy.y);
            ctx.fill();
        }

        function drawBlocks() {
            blocks.forEach(block => {
                switch(block.type) {
                    case 'green': ctx.fillStyle = 'green'; break;
                    case 'yellow': ctx.fillStyle = 'yellow'; break;
                    case 'purple': ctx.fillStyle = 'purple'; break;
                    case 'blue': ctx.fillStyle = 'blue'; break;
                }
                ctx.fillRect(block.x - 5, block.y - 5, 10, 10);
            });
        }

        function movePlayer(dx, dy) {
            const newX = player.x + dx;
            const newY = player.y + dy;
            if (newX > 10 && newX < 390 && newY > 10 && newY < 390 &&
                maze[Math.floor(newY/20)][Math.floor(newX/20)] !== 1) {
                player.x = newX;
                player.y = newY;
            }
        }

        function moveEnemy() {
            const speed = isEnemySlowed ? 0.5 : 1;
            let newX = enemy.x + Math.cos(enemy.angle) * speed;
            let newY = enemy.y + Math.sin(enemy.angle) * speed;

            if (newX < 10 || newX > 390 || newY < 10 || newY > 390 ||
                maze[Math.floor(newY/20)][Math.floor(newX/20)] === 1) {
                enemy.angle = Math.random() * Math.PI * 2;
            } else {
                enemy.x = newX;
                enemy.y = newY;
            }
        }

        function checkCollision() {
            blocks.forEach((block, index) => {
                if (Math.abs(player.x - block.x) < 10 && Math.abs(player.y - block.y) < 10) {
                    switch(block.type) {
                        case 'green': score += 1; break;
                        case 'yellow': score += 3; break;
                        case 'purple': 
                            isPlayerInvisible = true;
                            setTimeout(() => isPlayerInvisible = false, 2000);
                            break;
                        case 'blue': 
                            isEnemySlowed = true;
                            setTimeout(() => isEnemySlowed = false, 3000);
                            break;
                    }
                    blocks.splice(index, 1);
                    generateBlock();
                    scoreElement.textContent = score;
                }
            });

            if (!isPlayerInvisible) {
                const dx = player.x - enemy.x;
                const dy = player.y - enemy.y;
                const distance = Math.sqrt(dx*dx + dy*dy);
                const angle = Math.atan2(dy, dx);
                if (distance < 60 && Math.abs(angle - enemy.angle) < Math.PI/4) {
                    isGameOver = true;
                    alert('遊戲結束！你的得分是: ' + score);
                }
            }
        }

        function gameLoop() {
            if (isGameOver) return;

            ctx.clearRect(0, 0, 400, 400);
            drawMaze();
            drawPlayer();
            drawEnemy();
            drawBlocks();
            moveEnemy();

            if (joystickActive) {
                const dx = Math.cos(joystickAngle) * 2;
                const dy = Math.sin(joystickAngle) * 2;
                movePlayer(dx, dy);
            }

            checkCollision();

            requestAnimationFrame(gameLoop);
        }

        startButton.addEventListener('click', () => {
            isGameOver = false;
            score = 0;
            scoreElement.textContent = score;
            generateSimpleMaze();
            
            const playerPos = findSafePosition();
            player = { x: playerPos.x, y: playerPos.y, size: 10 };
            
            const enemyPos = findSafePosition();
            enemy = { x: enemyPos.x, y: enemyPos.y, size: 10, angle: Math.random() * Math.PI * 2, speed: 1 };
            
            blocks = [];
            for (let i = 0; i < 5; i++) generateBlock();
            gameLoop();
        });

        document.addEventListener('keydown', (event) => {
            if (isGameOver) return;
            switch (event.key) {
                case 'ArrowUp': movePlayer(0, -5); break;
                case 'ArrowDown': movePlayer(0, 5); break;
                case 'ArrowLeft': movePlayer(-5, 0); break;
                case 'ArrowRight': movePlayer(5, 0); break;
            }
        });

        function handleJoystickMove(e) {
            if (!joystickActive) return;
            
            const joystickRect = joystickContainer.getBoundingClientRect();
            const centerX = joystickRect.width / 2;
            const centerY = joystickRect.height / 2;
            
            let clientX, clientY;
            if (e.type.startsWith('touch')) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }

            const dx = clientX - joystickRect.left - centerX;
            const dy = clientY - joystickRect.top - centerY;
            
            joystickAngle = Math.atan2(dy, dx);
            
            const distance = Math.min(Math.sqrt(dx*dx + dy*dy), centerX);
            const x = Math.cos(joystickAngle) * distance + centerX;
            const y = Math.sin(joystickAngle) * distance + centerY;
            
            joystick.style.left = `${x}px`;
            joystick.style.top = `${y}px`;
        }

        function resetJoystick() {
            joystickActive = false;
            joystick.style.left = '50px';
            joystick.style.top = '50px';
        }

        joystickContainer.addEventListener('mousedown', (e) => {
            joystickActive = true;
            handleJoystickMove(e);
        });

        joystickContainer.addEventListener('touchstart', (e) => {
            joystickActive = true;
            handleJoystickMove(e);
        });

        document.addEventListener('mousemove', handleJoystickMove);
        document.addEventListener('touchmove', handleJoystickMove, { passive: false });

        document.addEventListener('mouseup', resetJoystick);
        document.addEventListener('touchend', resetJoystick);
    </script>
</body>
</html>